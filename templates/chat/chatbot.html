{% extends "base.html" %} {% load static %} {% block head %}

<style>
    body{margin-top:20px;}
    
    .chat-online {
        color: #34ce57
    }
    
.chat-offline {
    color: #e4606d
}

.chat-messages {
    display: flex;
    flex-direction: column;
    max-height: 400px;
    min-height: 400px;
    overflow-y: scroll
}

.chat-message-left,
.chat-message-right {
    display: flex;
    flex-shrink: 0
}

.chat-message-left {
    width: 55%;
    margin-right: auto;
    
}

.chat-message-right {
    flex-direction: row-reverse;
    margin-left: auto;
    width: 55%;
}
.py-3 {
    padding-top: 1rem!important;
    padding-bottom: 1rem!important;
}
.px-4 {
    padding-right: 1.5rem!important;
    padding-left: 1.5rem!important;
}
.flex-grow-0 {
    flex-grow: 0!important;
}
.border-top {
    border-top: 1px solid #dee2e6!important;
}
.rounded-box{
    border-radius: 10px !important;
}


    table, th, td {
      border: 1px solid black;
      padding: 5px 15px;
    }
    table {
      border-spacing: 15px;
    }
    tr{
        border-bottom: 1px solid black !important;
    }

</style>

{% endblock head %} {% block body %}

<main class="content">
    <div class="container p-0">
		<h1 class="h3 mb-3 text-center"> Medic Pro AI</h1>
		<div class="card">
			<div class="row g-0">
                <div class="col-12">
                </div>
					<div class="position-relative">
						<div class="chat-messages p-4" id="chat-container"> 
					</div>
					<div class="flex-grow-0 py-3 px-4 border-top">
                        <form id="chat_form">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Type your message" name="query" id="chat_query">
                                <button class="btn btn-primary" id="submit_form">Send</button>
                            </div>
                        </form>
					</div>
				</div>
			</div>
		</div>
	</div>
</main>
{% endblock body %}
{% block js %}
<script>
function generateChatMessage(message, timestamp) {
    return `
        <div class="chat-message-left pb-4">
            <div>
                <img src="{% static 'site/img/logos/login-banner.png' %}" class="rounded-circle mr-1 mt-3 me-1" alt="Sharon Lessman" width="40" height="40">
            </div>
            <div class="flex-shrink-1 bg-light rounded-box py-2 px-3 ml-3">
                <div class="font-weight-bold mb-1">Medic-Pro AI - <span class="text-muted small text-nowrap mt-2">${timestamp}</span></div>
                <p>
                ${message}
                <p>
            </div>
        </div>
    `;
}

// Function to append message to chat container
function appendMessageToContainer(message, timestamp) {
    var chatContainer = document.getElementById("chat-container");
    if (chatContainer) {
        const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
        chatContainer.innerHTML += generateChatMessage(message, currentTime);
    } else {
        console.error("Chat container not found!");
    }
}

appendMessageToContainer("Hello how can i assist you today?")

// Create a function to generate chat message HTML
function generateRightChatMessage(message, timestamp) {
    return `
        <div class="chat-message-right pb-4">
            <div>
                {% if user.avatar %}
                <img src="/media/{{ user.avatar }}" class="rounded-circle mr-1 mt-3 ms-1" alt="Chris Wood" width="40" height="40">
                {% else %}
                <img src="{% static 'db/images/20.jpg' %}" class="rounded-circle mr-1 mt-3 ms-1" alt="Chris Wood" width="40" height="40">
                {% endif %}

            </div>
            <div class="flex-shrink-1 bg-light rounded-box py-2 px-3 mr-3">
                <div class="font-weight-bold mb-1">You - <span class="text-muted small text-nowrap mt-2">${timestamp}</span></div>
                ${message}
            </div>
        </div>
    `;
}

// Function to append message to chat container
function appendRightMessageToContainer(message, timestamp) {
    var chatContainer = document.getElementById("chat-container");
    if (chatContainer) {
        const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
        chatContainer.innerHTML += generateRightChatMessage(message, currentTime);
    } else {
        console.error("Chat container not found!");
    }
}

function submitFormWithAjax() {
    const formData = $("#chat_form").serialize();
    const query = document.getElementById("chat_query").value;
    const djangoUrl = "{% url 'chat_bot' %}";
    const chatArea = document.querySelector("#chat-container")
    appendRightMessageToContainer(query)
    chatArea.scrollTop = chatArea.scrollHeight;
    // Make the AJAX request
    
    document.getElementById("chat_query").value = "";
    $.ajax({
        type: "POST",
        url: djangoUrl,
        data: formData,
        success: function(data) {
            appendMessageToContainer(data.response)
            chatArea.scrollTop = chatArea.scrollHeight;
        },
        error: function(xhr, textStatus, errorThrown) {
            console.error('There was a problem with the AJAX request:', textStatus, errorThrown);
        }
    });
}
// Listen for the form submission event
$("#chat_form").submit(function(event) {
    event.preventDefault();
    submitFormWithAjax();
});

</script>
{% endblock js %}